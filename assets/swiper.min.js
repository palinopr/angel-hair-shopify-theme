/**
 * Swiper 10 - Minimal Custom Build
 * Core functionality for product carousels
 */

class Swiper {
  constructor(el, options = {}) {
    this.el = typeof el === 'string' ? document.querySelector(el) : el;
    if (!this.el) return;
    
    this.options = {
      slidesPerView: 1,
      spaceBetween: 0,
      loop: false,
      autoplay: false,
      speed: 300,
      navigation: false,
      pagination: false,
      breakpoints: {},
      ...options
    };
    
    this.wrapper = this.el.querySelector('.swiper-wrapper');
    this.slides = this.el.querySelectorAll('.swiper-slide');
    this.currentIndex = 0;
    this.isAnimating = false;
    this.autoplayTimer = null;
    
    this.init();
  }
  
  init() {
    if (!this.wrapper || this.slides.length === 0) return;
    
    this.calculateDimensions();
    this.setupNavigation();
    this.setupPagination();
    this.setupAutoplay();
    this.setupTouchEvents();
    this.setupResize();
    this.updateSlides();
  }
  
  calculateDimensions() {
    const containerWidth = this.el.offsetWidth;
    let slidesPerView = this.options.slidesPerView;
    let spaceBetween = this.options.spaceBetween;
    
    // Apply breakpoints
    if (this.options.breakpoints) {
      const breakpoints = Object.keys(this.options.breakpoints)
        .map(Number)
        .sort((a, b) => a - b);
      
      for (const bp of breakpoints) {
        if (window.innerWidth >= bp) {
          const bpOptions = this.options.breakpoints[bp];
          if (bpOptions.slidesPerView) slidesPerView = bpOptions.slidesPerView;
          if (bpOptions.spaceBetween !== undefined) spaceBetween = bpOptions.spaceBetween;
        }
      }
    }
    
    this.slidesPerView = slidesPerView;
    this.spaceBetween = spaceBetween;
    
    const totalGaps = (slidesPerView - 1) * spaceBetween;
    this.slideWidth = (containerWidth - totalGaps) / slidesPerView;
    
    this.slides.forEach((slide, i) => {
      slide.style.width = `${this.slideWidth}px`;
      slide.style.marginRight = i < this.slides.length - 1 ? `${spaceBetween}px` : '0';
    });
    
    this.maxIndex = Math.max(0, this.slides.length - Math.floor(slidesPerView));
  }
  
  setupNavigation() {
    if (!this.options.navigation) return;
    
    const nav = this.options.navigation;
    this.prevButton = nav.prevEl ? document.querySelector(nav.prevEl) : null;
    this.nextButton = nav.nextEl ? document.querySelector(nav.nextEl) : null;
    
    if (this.prevButton) {
      this.prevButton.addEventListener('click', () => this.slidePrev());
    }
    if (this.nextButton) {
      this.nextButton.addEventListener('click', () => this.slideNext());
    }
  }
  
  setupPagination() {
    if (!this.options.pagination) return;
    
    const pag = this.options.pagination;
    this.paginationEl = pag.el ? document.querySelector(pag.el) : null;
    
    if (this.paginationEl && pag.clickable) {
      this.paginationEl.innerHTML = '';
      const totalBullets = this.maxIndex + 1;
      
      for (let i = 0; i < totalBullets; i++) {
        const bullet = document.createElement('span');
        bullet.className = 'swiper-pagination-bullet';
        if (i === 0) bullet.classList.add('swiper-pagination-bullet-active');
        bullet.addEventListener('click', () => this.slideTo(i));
        this.paginationEl.appendChild(bullet);
      }
    }
  }
  
  setupAutoplay() {
    if (!this.options.autoplay) return;
    
    const delay = this.options.autoplay.delay || 3000;
    
    this.startAutoplay = () => {
      this.stopAutoplay();
      this.autoplayTimer = setInterval(() => {
        if (this.currentIndex >= this.maxIndex) {
          this.slideTo(0);
        } else {
          this.slideNext();
        }
      }, delay);
    };
    
    this.stopAutoplay = () => {
      if (this.autoplayTimer) {
        clearInterval(this.autoplayTimer);
        this.autoplayTimer = null;
      }
    };
    
    this.startAutoplay();
    
    if (this.options.autoplay.pauseOnMouseEnter) {
      this.el.addEventListener('mouseenter', this.stopAutoplay);
      this.el.addEventListener('mouseleave', this.startAutoplay);
    }
  }
  
  setupTouchEvents() {
    let startX = 0;
    let startY = 0;
    let moveX = 0;
    let isDragging = false;
    
    const onStart = (e) => {
      isDragging = true;
      startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
      moveX = 0;
    };
    
    const onMove = (e) => {
      if (!isDragging) return;
      const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
      moveX = currentX - startX;
      
      // If horizontal movement is greater, prevent default
      if (Math.abs(moveX) > Math.abs(currentY - startY)) {
        e.preventDefault();
      }
    };
    
    const onEnd = () => {
      if (!isDragging) return;
      isDragging = false;
      
      const threshold = this.slideWidth * 0.2;
      if (moveX < -threshold && this.currentIndex < this.maxIndex) {
        this.slideNext();
      } else if (moveX > threshold && this.currentIndex > 0) {
        this.slidePrev();
      }
    };
    
    this.el.addEventListener('touchstart', onStart, { passive: true });
    this.el.addEventListener('touchmove', onMove, { passive: false });
    this.el.addEventListener('touchend', onEnd);
    this.el.addEventListener('mousedown', onStart);
    this.el.addEventListener('mousemove', onMove);
    this.el.addEventListener('mouseup', onEnd);
    this.el.addEventListener('mouseleave', onEnd);
  }
  
  setupResize() {
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        this.calculateDimensions();
        this.updateSlides();
      }, 100);
    });
  }
  
  slideTo(index) {
    if (this.isAnimating) return;
    this.isAnimating = true;
    
    this.currentIndex = Math.max(0, Math.min(index, this.maxIndex));
    this.updateSlides();
    
    setTimeout(() => {
      this.isAnimating = false;
    }, this.options.speed);
  }
  
  slideNext() {
    if (this.currentIndex < this.maxIndex) {
      this.slideTo(this.currentIndex + 1);
    } else if (this.options.loop) {
      this.slideTo(0);
    }
  }
  
  slidePrev() {
    if (this.currentIndex > 0) {
      this.slideTo(this.currentIndex - 1);
    } else if (this.options.loop) {
      this.slideTo(this.maxIndex);
    }
  }
  
  updateSlides() {
    const offset = -(this.currentIndex * (this.slideWidth + this.spaceBetween));
    this.wrapper.style.transform = `translateX(${offset}px)`;
    this.wrapper.style.transition = `transform ${this.options.speed}ms ease`;
    
    // Update navigation buttons
    if (this.prevButton) {
      this.prevButton.classList.toggle('swiper-button-disabled', this.currentIndex === 0 && !this.options.loop);
    }
    if (this.nextButton) {
      this.nextButton.classList.toggle('swiper-button-disabled', this.currentIndex >= this.maxIndex && !this.options.loop);
    }
    
    // Update pagination
    if (this.paginationEl) {
      const bullets = this.paginationEl.querySelectorAll('.swiper-pagination-bullet');
      bullets.forEach((bullet, i) => {
        bullet.classList.toggle('swiper-pagination-bullet-active', i === this.currentIndex);
      });
    }
  }
  
  destroy() {
    this.stopAutoplay?.();
  }
}

// Export for use
window.Swiper = Swiper;

